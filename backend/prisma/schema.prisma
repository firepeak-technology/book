generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model Family {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  ownedBooks FamilyBook[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  familyId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family    Family?    @relation(fields: [familyId], references: [id], onDelete: SetNull)
  readBooks UserBook[]

  @@index([familyId])
}

model Book {
  id            String   @id @default(uuid())
  isbn          String?  @unique
  isbn13        String?  @unique
  title         String
  subtitle      String?
  description   String?  @db.Text
  pageCount     Int?
  publishedDate String?
  publisher     String?
  language      String?  @default("en")
  coverUrl      String?
  thumbnailUrl  String?
  type          BookType @default(BOOK)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  authors     BookAuthor[]
  categories  BookCategory[]
  collections BookCollection[]
  familyBooks FamilyBook[]
  userBooks   UserBook[]

  @@index([isbn])
  @@index([isbn13])
  @@index([title])
}

enum BookType {
  BOOK
  COMIC
  MANGA
  GRAPHIC_NOVEL
  MAGAZINE
  AUDIOBOOK
}

model Author {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  books BookAuthor[]
}

model BookAuthor {
  bookId   String
  authorId String
  order    Int    @default(0)

  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  author Author @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@id([bookId, authorId])
  @@index([bookId])
  @@index([authorId])
}

model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  books BookCategory[]
}

model BookCategory {
  bookId     String
  categoryId String

  book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([bookId, categoryId])
  @@index([bookId])
  @@index([categoryId])
}

model Collection {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  books BookCollection[]
}

model BookCollection {
  bookId       String
  collectionId String
  volumeNumber Int?

  book       Book       @relation(fields: [bookId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([bookId, collectionId])
  @@index([bookId])
  @@index([collectionId])
}

model FamilyBook {
  id            String        @id @default(uuid())
  familyId      String
  bookId        String
  purchaseDate  DateTime?
  purchasePrice Float?
  location      String?
  condition     BookCondition @default(GOOD)
  notes         String?       @db.Text
  addedAt       DateTime      @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([familyId, bookId])
  @@index([familyId])
  @@index([bookId])
}

enum BookCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

model UserBook {
  id         String        @id @default(uuid())
  userId     String
  bookId     String
  status     ReadingStatus @default(WANT_TO_READ)
  rating     Int?          @db.SmallInt
  review     String?       @db.Text
  startedAt  DateTime?
  finishedAt DateTime?
  addedAt    DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@index([bookId])
  @@index([status])
}

enum ReadingStatus {
  WANT_TO_READ
  READING
  FINISHED
  DNF
}
