// npx prisma migrate dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readBooks UserBook[]
}

model Book {
  id            String   @id @default(uuid())
  isbn          String?  @unique
  isbn13        String?  @unique
  title         String
  subtitle      String?
  description   String?  @db.Text
  pageCount     Int?
  publishedDate String?
  publisher     String?
  language      String?  @default("en")
  coverUrl      String?
  thumbnailUrl  String?
  type          BookType @default(BOOK)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  serieNumber   String?

  serieId String?
  serie   Series? @relation(fields: [serieId], references: [id], onDelete: SetNull)

  coverImageId String?
  coverImage   CoverImage? @relation(fields: [coverImageId], references: [id], onDelete: SetNull)

  authors    BookAuthor[]
  categories BookCategory[]
  userBooks  UserBook[]

  @@index([isbn])
  @@index([isbn13])
  @@index([title])
}

enum BookType {
  BOOK
  COMIC
  MANGA
  GRAPHIC_NOVEL
  MAGAZINE
  AUDIOBOOK
}

model Author {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  books BookAuthor[]
}

model BookAuthor {
  bookId   String
  authorId String
  order    Int    @default(0)

  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  author Author @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@id([bookId, authorId])
  @@index([bookId])
  @@index([authorId])
}

model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  books BookCategory[]
}

model BookCategory {
  bookId     String
  categoryId String

  book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([bookId, categoryId])
  @@index([bookId])
  @@index([categoryId])
}

model Series {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())

  books Book[]
}

model Collection {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
}

enum BookCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

model UserBook {
  id         String        @id @default(uuid())
  userId     String
  bookId     String
  status     ReadingStatus @default(WANT_TO_READ)
  rating     Int?          @db.SmallInt
  review     String?       @db.Text
  startedAt  DateTime?
  finishedAt DateTime?
  addedAt    DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  own           Boolean       @default(false)
  purchaseDate  DateTime?
  purchasePrice Float?
  location      String?
  condition     BookCondition @default(GOOD)
  notes         String?       @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@index([bookId])
  @@index([status])
}

enum ReadingStatus {
  WANT_TO_READ
  READING
  FINISHED
  DNF
}

model CoverImage {
  id          String  @id @default(uuid())
  originalUrl String? // Original URL if downloaded from web
  filename    String // Original filename
  mimeType    String // e.g., image/jpeg
  size        Int // File size in bytes

  // Full size image
  imagePath String // Path to stored image
  imageUrl  String // Public URL to access image

  // Thumbnail
  thumbnailPath String // Path to stored thumbnail
  thumbnailUrl  String // Public URL to access thumbnail

  width  Int? // Original image width
  height Int? // Original image height

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  books Book[] // One image can be used by multiple books
}
